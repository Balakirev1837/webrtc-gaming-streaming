services:
  broadcast-box:
    image: seaduboi/broadcast-box:latest
    container_name: broadcast-box
    network_mode: "host"
    environment:
      - HTTP_ADDRESS=:8080
      - UDP_MUX_PORT=8080
      - INCLUDE_LOOPBACK_CANDIDATE=true
    restart: unless-stopped

  streamer:
    build: ./control-panel
    container_name: gaming-streamer
    network_mode: "host"
    # Remove privileged mode - use specific capabilities instead
    # privileged: true
    # Add specific capabilities
    cap_add:
      - SYS_RAWIO  # For capture card access
    cap_drop:
      - ALL  # Drop all other capabilities for security
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    devices:
      # Only map specific video devices, not entire /dev
      - /dev/video0:/dev/video0:rwm
      - /dev/snd:/dev/snd:rwm  # For audio
    depends_on:
      - broadcast-box
    environment:
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
      - SERVER_URL=http://localhost:8080/api/whip
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs  # Persist logs outside container
      - /run/user/${UID:-1000}/pulse:/run/user/1000/pulse
      - ${HOME}/.config/pulse/cookie:/home/streamer/.config/pulse/cookie:ro
    # Add resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    # Add health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
