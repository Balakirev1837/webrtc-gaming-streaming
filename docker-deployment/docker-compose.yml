version: "3.8"

services:
  broadcast-box:
    image: seaduboi/broadcast-box:latest
    container_name: broadcast-box
    network_mode: "host"
    environment:
      - HTTP_ADDRESS=:8080
      - UDP_MUX_PORT=8080
      - INCLUDE_LOOPBACK_CANDIDATE=true
    restart: unless-stopped

  streamer:
    build: ./control-panel
    container_name: gaming-streamer
    network_mode: "host"
    privileged: true  # Simplifies hardware access (GPU, capture cards)
    depends_on:
      - broadcast-box
    environment:
      # Audio: PulseAudio socket is mounted from host
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
      - SERVER_URL=http://localhost:8080/api/whip
    volumes:
      # Persist configuration
      - ./config:/app/config
      # Map video devices
      - /dev:/dev
      # Map PulseAudio socket (Adjust user ID 1000 if needed)
      - /run/user/${UID:-1000}/pulse:/run/user/1000/pulse
      # Map PulseAudio cookie if needed (often required)
      - ${HOME}/.config/pulse/cookie:/root/.config/pulse/cookie
    restart: unless-stopped
